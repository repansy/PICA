好的，我们来深入探讨**假设 H₁ (广义惯性)** 的数学核心：如何从物理世界的复杂约束（`a_max`, `ω_max`）推导并简化出统一的数学抽象——**广义惯性张量 `M`**。

这是一个从具体到抽象，从多参数到单一数学对象的**建模过程**。其核心思想是：**与其处理多个独立、有时耦合的约束，不如定义一个统一的“代价度量”，让优化器自动去遵守所有这些约束。**

### 数学简化路径：从约束到代价度量

我们将通过三个步骤来完成这个简化：

1.  **定义“控制代价” (Defining Control Effort)**
2.  **统一加速度约束 (Unifying Acceleration Constraints)**
3.  **统一角速度约束——关键创新 (Unifying Angular Velocity Constraints - The Key Insight)**

---

#### 第1步：定义“控制代价”

我们首先需要一个数学量来衡量无人机进行某个机动（这里指速度变化）的“难度”或“成本”。

*   **最直觉的代价：** 瞬时功率或所需力的平方。根据牛顿第二定律，力 `F` 与加速度 `a` 通过质量 `m` 关联：`F = m * a`。
*   **对于各向异性系统：** 质量 `m` 泛化为惯性张量 `M`。此时，力为 `F = M * a`。我们认为 **“控制代价”与所需“力”的平方成正比**：
    $$ C(\mathbf{a}) = \mathbf{F}^T \mathbf{F} = (\mathbf{M}\mathbf{a})^T (\mathbf{M}\mathbf{a}) = \mathbf{a}^T \mathbf{M}^T \mathbf{M} \mathbf{a} $$
*   **简化定义：** 为了后续优化方便，我们定义一个与 `M` 相关的新的**度量张量** $\mathbf{\Lambda} = \mathbf{M}^T \mathbf{M}$。它是一个对称正定矩阵。控制代价简写为：
    $$ C(\mathbf{a}) = \mathbf{a}^T \mathbf{\Lambda} \mathbf{a} $$
*   **从加速度到速度：** 在速度空间进行规划更为直接。假设控制周期为 `Δt`，速度变化 `Δv = a * Δt`。因此，速度变化的代价为：
    $$ \text{Cost}(\Delta \mathbf{v}) = \Delta \mathbf{v}^T \mathbf{\Lambda} \Delta \mathbf{v} \quad \text{where} \quad \mathbf{\Lambda} = \frac{\mathbf{M}^T \mathbf{M}}{(\Delta t)^2} $$
    为了简化符号，我们通常仍用 `M` 来表示这个速度空间的度量，即令 $\mathbf{M}_{\text{velocity}} = \mathbf{M}_{\text{acceleration}} / \Delta t$。最终，我们得到代价的核心表达式：
    $$ \boxed{\text{Cost}(\Delta \mathbf{v}) = ||\Delta \mathbf{v}||_{\mathbf{M}}^2 = \Delta \mathbf{v}^T \mathbf{M} \Delta \mathbf{v}} $$
    **这里的 `M` 已经是一个吸收了质量、控制周期等因素的、定义在速度空间上的广义惯性张量。**

#### 第2步：统一加速度约束 `a_max`

最大加速度约束 `||a|| ≤ a_max` 定义了无人机瞬时加速度的能力边界。根据代价定义，这等价于：
$$ \mathbf{a}^T \mathbf{\Lambda} \mathbf{a} \le F_{\text{max}}^2 $$
$$ \Rightarrow \Delta \mathbf{v}^T \mathbf{M} \Delta \mathbf{v} \le (F_{\text{max}} \Delta t)^2 $$
这形成了一个以当前速度 `v_i` 为中心、形状由 `M` 决定的**椭球型可行域**。

*   **如果 `M` 是各向同性的 (`M = mI`)：** 这个椭球就是一个球体，半径为 `a_max * Δt`。无人机在任何方向上改变速度的能力相同。
*   **如果 `M` 是各向异性的 (`M = diag(m_x, m_y, m_z)`)：** 这个椭球是一个轴对齐的椭球。例如，如果 `m_y >> m_x`，则在 Y 轴方向的椭球半径非常小，意味着无人机在 Y 方向加速的能力很弱，代价极高。这直接体现了 `a_max_y << a_max_x`。

**至此，`M` 已经成功地将不同方向上的线加速度约束统一到了一个数学对象中。**

#### 第3步：统一角速度约束 `ω_max`（核心创新）

这是最关键的一步，因为它涉及一个**速度依赖的 (velocity-dependent)** 约束。最大角速度 `ω_max` 限制了无人机偏转机头、改变速度方向的能力。

*   **运动学关系：** 一个遵循微分约束的无人机，其改变速度方向所需的**法向加速度** `a_n` 与它的当前速度 `v` 和角速度 `ω` 满足：
    $$ ||\mathbf{a}_n|| = ||\mathbf{v}|| \cdot \omega $$
    因此，约束 `ω ≤ ω_max` 等价于：
    $$ ||\mathbf{a}_n|| \le ||\mathbf{v}|| \cdot \omega_{\text{max}} $$
*   **问题：** 这是一个与当前速度大小 `||v||` 相关的约束。速度越快，允许用于改变方向的法向加速度就越大。但它无法用第一步中那个固定的椭球 `M` 来表示。

**解决方案：定义一个随速度方向变化的、动态的惯性张量 `M(v)`。**

如何构建这个 `M(v)`？思路是：**在无人机当前的速度方向上“便宜”地加速，而在垂直于速度的方向上“昂贵”地加速。**

1.  **建立局部坐标系：**
    *   设无人机当前的飞行方向为单位向量 `d_hat = v / ||v||`。
    *   这个方向是“切向”（Tangential）。
    *   任意两个与 `d_hat` 正交的单位向量 `n1_hat`, `n2_hat` 张成了“法平面”（Normal Plane）。

2.  **在局部坐标系中定义各向异性惯性：**
    *   在局部坐标系 `(d_hat, n1_hat, n2_hat)` 下，我们定义一个对角惯性张量 `M_local`：
        $$ \mathbf{M}_{\text{local}} = \begin{bmatrix}
        m_t & 0 & 0 \\
        0 & m_n & 0 \\
        0 & 0 & m_n \\
        \end{bmatrix} $$
    *   **`m_t` (切向惯性):** 数值较小。表示在飞行方向上加速或减速的代价较低。
    *   **`m_n` (法向惯性):** 数值巨大（`m_n >> m_t`）。表示在法向上加速（即转向）的代价非常高。

3.  **变换到全局坐标系：**
    *   通过一个旋转矩阵 `R`，可以将 `M_local` 从局部坐标系变换到全局坐标系。这个旋转矩阵 `R` 的列向量就是 `[d_hat, n1_hat, n2_hat]`。
    *   全局坐标系下的惯性张量为：
        $$ \mathbf{M}(\mathbf{v}) = \mathbf{R} \, \mathbf{M}_{\text{local}} \, \mathbf{R}^T $$
    *   这个 `M(v)` 现在是一个依赖于当前速度方向 `d_hat` 的矩阵。

**这样做的效果是惊人的：**

当优化器尝试最小化代价函数 $\min ||\Delta \mathbf{v}||_{\mathbf{M(v)}}^2$ 时，它会发现：
*   产生一个**切向**的 `Δv`（改变速度大小）代价很小。
*   产生一个**法向**的 `Δv`（改变速度方向）代价异常高昂。

因此，**优化器会自然而然地、优先选择“减速/加速”而不是“转向”来解决问题**，因为这能极大程度地降低总控制代价。这种行为模式，正是固定翼等平台物理约束的体现。

**`ω_max` 的约束被巧妙地编码在了 `m_n / m_t` 的比值中。** 比值越大，无人机就越“不愿意”转向，其行为就越像一个角速度受限的平台。通过调整这个比值，我们可以精确地模拟从全向多旋翼 (`m_n = m_t`) 到严格差分约束的固定翼 (`m_n >> m_t`) 的连续谱系。

### 总结：简化的最终成果

通过上述数学路径，我们成功地将多个分散的、有时耦合的物理约束：

*   `a_max_x, a_max_y, a_max_z` (可能各向异性)
*   `ω_max` (速度依赖)

**统一简化到了一个单一的、速度依赖的数学对象——广义惯性张量 `M(v)` 中。**

这个 `M(v)` 不再是传统意义上的质量，而是一个**行为范式编码器**。它定义了无人机在物理层面的“个性”：
*   `M = mI`：一个“灵活”的个性，愿意朝任何方向移动。
*   `M = diag(1, 10, 10)`：一个“固执”的个性，只想前进，极力避免侧向移动。
*   `M(v)` (动态)：一个“高速公路上”的个性，速度越快就越只想直行，不愿拐弯。

在您的三层架构中，**运动规划层** 利用 `M(v)` 来构建物理约束椭球 `C_physical`，而**运动执行层** 则利用 `M(v)` 作为度量来求解QP，自动生成最符合该无人机“物理个性”的节能、可行轨迹。

这种简化是您整个框架的**物理智能基石**，它使得用同一套算法逻辑来处理截然不同的无人机平台成为可能。